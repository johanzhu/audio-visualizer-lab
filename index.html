<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>audio visualizer 1</title>
	</head>
	<script type="text/javascript" src="lib/three.js" ></script>
	<script type="text/javascript" src="js/world.js" ></script>
	<body>
	<style>
		html,body{
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
			overflow: hidden;
			background-color: white;
		}
	</style>
		<script>
			
			var world,
				sound,
				analyser,
				listener,
				balls = [];
						
			
			loadMusic(onComplete);
			
			
			function loadMusic(onComplete) {
				
				listener = new THREE.AudioListener();
				
				sound = new THREE.Audio(listener);
				
				analyser = new THREE.AudioAnalyser(sound, 128);
				
				var audioLoader = new THREE.AudioLoader();
				
				audioLoader.load('./assets/music.mp3',function(buffer) {
					
					sound.setBuffer( buffer );
					
					sound.setLoop(false);
					
					sound.setVolume(0.5);
					
					window.addEventListener('click',function() {
						sound.play();
					});
					
					window.addEventListener('touchstart',function() {
						sound.play();
					});
					
					onComplete();
					
				});
				
				
			}
			
			function onComplete() {
				
				initWorld();
				
				createScene();
				
				animate();
				
			}
			
			function initWorld() {
				
				world = new World();
				
				world.init();
				
				world.removeAxes();
				
			}
			
			function createScene() {
				
				var gap = 8;
				
				for(var i = 0; i < 8; i++) {
					
					for(var j = 0; j < 8; j++) {
						
						var color = '#'+Math.random().toString(16).substr(-6);
						
						var ball = new THREE.Mesh(
							new THREE.SphereGeometry(1,64,64),
							new THREE.MeshPhongMaterial({color:color})
						);
						
						balls.push(ball);
						
						ball.position.set(i * gap,j * gap,0);
						
						world.scene.add(ball);
						
					}
					
				}
				
				world.camera.position.set(28,28,130);
				
				var light = new THREE.DirectionalLight();
				
				light.position.set(2,0,1);
				
				world.scene.add(light);
				
			}
			
			function keepWithMuic() {
				
				var fdata = analyser.getFrequencyData();
				
				var afdata = analyser.getAverageFrequency();
				
				for(var i = 0; i < 64; i++) {
					
					var ratio = fdata[i]/80;
					
					var oriPos = balls[i].position;
					
					var r = Math.random() > 0.5 ? 1 : -1;
					
					if(ratio > 0) {
						
						balls[i].scale.set(ratio,ratio,ratio);
						
						//balls[i].position.set(oriPos.x + r * ratio/50, oriPos.y + r * ratio/50,0);
					}
						
				}
				
				if(afdata > 0)
					world.camera.position.z = 80 * afdata/100;
				
			}
			
			function animate() {
				requestAnimationFrame(animate);
				keepWithMuic();
				world.render();
			}
			
			
		</script>
	</body>
</html>
